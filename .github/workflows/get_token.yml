name: Upload Folder to GDrive

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  upload:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # 模拟生成一个包含多个文件的文件夹
      - name: Prepare Folder
        run: |
          mkdir -p my_backup
          echo "Content 1" > my_backup/file1.txt
          echo "Content 2" > my_backup/file2.txt
          mkdir -p my_backup/subfolder
          echo "Nested content" > my_backup/subfolder/file3.txt

      - name: Install Rclone
        run: sudo apt-get install -y rclone

      - name: Setup Rclone with Service Account
        run: |
          mkdir -p ~/.config/rclone/
          # 直接利用 Secret 生成配置文件
          cat << EOF > ~/.config/rclone/rclone.conf
          [gdrive]
          type = drive
          service_account_contents = ${{ secrets.GDRIVE_SERVICE_ACCOUNT }}
          EOF

      - name: Upload Folder
        run: |
          # my_backup: 本地文件夹路径
          # gdrive: rclone.conf 里的配置名
          # 1abc123...: 你在 Google Drive 共享文件夹的 ID
          rclone copy ./my_backup gdrive: --drive-root-folder-id "${{ secrets.GDRIVE_FOLDER_ID }}" --progress
