name: Upload to Google Drive

on:
  push:
    branches: [ main ]
  workflow_dispatch: 

jobs:
  upload-job:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Prepare Files
        run: |
          mkdir -p my_backup
          echo "Backup created at $(date)" > my_backup/backup_log.txt
          echo "This is a test file" > my_backup/test.txt

      - name: Install Rclone
        run: sudo apt-get install -y rclone

      - name: Setup Rclone Configuration
        env:
          SA_JSON: ${{ secrets.GDRIVE_SERVICE_ACCOUNT }}
        run: |
          mkdir -p ~/.config/rclone/
          # 使用双引号包裹环境变量，确保 JSON 的换行和引号被正确保留
          printf "%s" "$SA_JSON" > ~/.config/rclone/sa.json
          
          # 创建 rclone.conf
          cat << EOF > ~/.config/rclone/rclone.conf
          [gdrive]
          type = drive
          service_account_file = /home/runner/.config/rclone/sa.json
          server_side_across_configs = true
          EOF

      - name: Execute Rclone Upload
        run: |
          # 核心命令
          # --drive-root-folder-id 确保文件直接进入你共享过的那个文件夹
          # --drive-acknowledge-abuse 防止某些大文件因为 Google 扫描机制被拦截
          rclone copy ./my_backup gdrive,root_id="${{secrets.GDRIVE_FOLDER_ID}}": \
            --drive-acknowledge-abuse \
            -v
